name: Deploy Jouskaio.me

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.VPN_SERVER_IP }}
          REMOTE_USER: debian
          SCRIPT_AFTER: |
            set -e
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            cd /home/debian/Documents/jouskaio.me/WEB-Jouskaio.me
            git fetch --all
            git reset --hard origin/main

            if ! command -v yarn > /dev/null; then
              npm install -g yarn
            fi

            rm -rf node_modules .next package-lock.json yarn.lock
            yarn install
            yarn build

            pm2 start ecosystem.config.js --env $ENVIRONMENT || pm2 reload ecosystem.config.js --env $ENVIRONMENT

      - name: Discord notification on success
        if: success()
        uses: Ilshidur/action-discord@master
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: ":white_check_mark: Déploiement de **Jouskaio.me** terminé avec succès sur la branche **main** !"

      - name: Discord notification on failure
        if: failure()
        uses: Ilshidur/action-discord@master
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: ":x: Le déploiement de **Jouskaio.me** a échoué. Va checker les logs GitHub Actions !"
